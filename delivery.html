<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –î–æ—Å—Ç–∞–≤–∫–∏ –ó–∞–∫–∞–∑–æ–≤</title>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --brand:#2563eb;
      --brand2:#1d4ed8;
      --border:#e5e7eb;
      --danger:#dc2626;
      --ok:#16a34a;
      --shadow: 0 10px 25px rgba(0,0,0,.06);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:20px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Segoe UI Emoji";
      background:var(--bg); color:var(--text);
    }
    .container{
      max-width:1400px; margin:0 auto;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px;
    }
    h1{margin:0 0 6px 0; font-size:22px}
    .sub{color:var(--muted); margin:0 0 14px 0; line-height:1.35}
    h2{
      margin:22px 0 10px 0;
      font-size:18px;
      padding-bottom:6px;
      border-bottom:1px solid var(--border);
    }

    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.04);
    }
    .grow{flex:1}
    .stack{display:flex; flex-direction:column; gap:8px}

    label{font-size:12px; color:var(--muted)}
    input[type="file"], input[type="date"], input[type="text"], select{
      padding:10px 10px;
      border:1px solid var(--border);
      border-radius:10px;
      font-size:14px;
      outline:none;
      background:#fff;
      min-height:40px;
    }
    input:focus, select:focus{border-color: #93c5fd; box-shadow: 0 0 0 3px rgba(37,99,235,.12);}
    button{
      border:none;
      border-radius:10px;
      padding:10px 12px;
      background:var(--brand);
      color:#fff;
      cursor:pointer;
      font-size:14px;
      min-height:40px;
      transition: transform .04s ease, background .15s ease, opacity .15s ease;
    }
    button:hover{background:var(--brand2)}
    button:active{transform: translateY(1px)}
    button.secondary{
      background:#111827;
    }
    button.ghost{
      background:#fff;
      border:1px solid var(--border);
      color:var(--text);
    }
    button.danger{background:var(--danger)}
    button:disabled{
      opacity:.5; cursor:not-allowed;
      transform:none;
    }

    .hint{color:var(--muted); font-size:12px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-size:12px;
      color:var(--muted);
    }
    .pill strong{color:var(--text); font-weight:600}

    .grid4{
      display:grid;
      grid-template-columns: repeat(4, minmax(220px, 1fr));
      gap:12px;
    }
    @media (max-width:1100px){
      .grid4{grid-template-columns: repeat(2, minmax(220px, 1fr));}
    }
    @media (max-width:680px){
      .grid4{grid-template-columns: 1fr;}
      body{padding:12px}
    }
    .stat{
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      background:#fff;
    }
    .stat .k{color:var(--muted); font-size:12px}
    .stat .v{font-size:22px; margin-top:6px; font-weight:700}
    .stat .s{color:var(--muted); font-size:12px; margin-top:6px}

    .two{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width:1100px){
      .two{grid-template-columns:1fr;}
    }

    .chart-container{
      position:relative;
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:10px;
      background:#fff;
      min-height:320px;
    }

    table{
      width:100%;
      border-collapse: collapse;
      font-size:13px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
    }
    th, td{
      padding:10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      vertical-align:top;
    }
    th{background:#f9fafb; color:#374151; font-size:12px; text-transform:uppercase; letter-spacing:.02em}
    tr:hover td{background:#fafafa}
    .table-container{overflow:auto; border-radius:var(--radius)}

    /* Toasts */
    #toasts{
      position:fixed;
      right:14px;
      bottom:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:9999;
    }
    .toast{
      max-width: 360px;
      background:#111827;
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      font-size:13px;
      line-height:1.35;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .toast .dot{
      margin-top:6px;
      width:8px; height:8px; border-radius:999px;
      background:#93c5fd;
      flex:0 0 auto;
    }
    .toast.ok .dot{background:#86efac}
    .toast.err .dot{background:#fca5a5}

    /* Drop zone */
    .drop{
      border:1px dashed #cbd5e1;
      background:#f8fafc;
      border-radius:var(--radius);
      padding:12px;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .drop strong{font-size:14px}
    .drop small{color:var(--muted)}
    .drop.dragover{border-color:#60a5fa; background:#eff6ff;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>

<body>
  <div class="container">
    <h1>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–∫–∞–∑–æ–≤</h1>
    <p class="sub">
      –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV –∏–ª–∏ XLSX. –§–∏–ª—å—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫ —Å–≤–æ–¥–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ, –≥—Ä–∞—Ñ–∏–∫–∞–º, —Ä–µ–π—Ç–∏–Ω–≥—É –∫—É—Ä—å–µ—Ä–æ–≤ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∞–º.
      <br>
      <span class="hint">
        –û–ø–æ–∑–¥–∞–Ω–∏–µ —Å—á–∏—Ç–∞–µ–º —Ç–∞–∫: <b>üöö –¥–æ—Å—Ç–∞–≤–∫–∞</b> ‚Äî —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–æ—Å—Ç–∞–≤–∫—É (–ø–µ—Ä–µ–¥–∞–Ω –≥–æ—Å—Ç—é / –æ–±—â–µ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏) —Å –æ–±–µ—â–∞–Ω–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º; <b>üè™ —Å–∞–º–æ–≤—ã–≤–æ–∑</b> ‚Äî –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å —Å –æ–±–µ—â–∞–Ω–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º.
      </span>
    </p>

    <!-- Upload -->
    <div class="card stack">
      <div class="row">
        <div class="drop grow" id="dropZone">
          <div class="stack" style="gap:2px">
            <strong>–§–∞–π–ª –¥–∞–Ω–Ω—ã—Ö</strong>
            <small>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ CSV/XLSX —Å—é–¥–∞ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É</small>
          </div>
          <div class="row" style="gap:8px">
            <input id="file-input" type="file" accept=".csv,.xlsx" />
            <button class="ghost" id="btnClear" disabled>–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
        </div>

        <span class="pill"><span class="mono" id="statusText">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span></span>
      </div>

      <div class="row">
        <div class="stack">
          <label>–†–µ–∂–∏–º —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –¥–∞—Ç–µ</label>
          <select id="mode-selector" onchange="toggleMode()">
            <option value="day">–û–¥–∏–Ω –¥–µ–Ω—å</option>
            <option value="period">–ü–µ—Ä–∏–æ–¥</option>
          </select>
        </div>

        <div class="row" id="date-inputs-day">
          <div class="stack">
            <label>–î–∞—Ç–∞</label>
            <input id="date-start" type="date"/>
          </div>
        </div>

        <div class="row" id="date-inputs-period" style="display:none;">
          <div class="stack">
            <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
            <input id="date-start-period" type="date"/>
          </div>
          <div class="stack">
            <label>–î–∞—Ç–∞ –∫–æ–Ω—Ü–∞</label>
            <input id="date-end-period" type="date"/>
          </div>
        </div>

        <div class="stack">
          <label>–¢–∏–ø –∑–∞–∫–∞–∑–∞</label>
          <select id="type-filter">
            <option value="all">–í—Å–µ</option>
            <option value="delivery">–¢–æ–ª—å–∫–æ –¥–æ—Å—Ç–∞–≤–∫–∞</option>
            <option value="pickup">–¢–æ–ª—å–∫–æ —Å–∞–º–æ–≤—ã–≤–æ–∑</option>
          </select>
        </div>

        <div class="stack">
          <label>–û–ø–æ–∑–¥–∞–Ω–∏–µ</label>
          <select id="lateness-filter">
            <option value="all">–í—Å–µ</option>
            <option value="late">–¢–æ–ª—å–∫–æ –æ–ø–æ–∑–¥–∞–≤—à–∏–µ</option>
            <option value="ontime">–¢–æ–ª—å–∫–æ –≤–æ–≤—Ä–µ–º—è</option>
          </select>
        </div>

        <div class="row" style="gap:8px">
          <button id="btnApply" onclick="runAnalysis()" disabled>–ü–æ–∫–∞–∑–∞—Ç—å</button>
          <button id="btnResetFilters" class="ghost" onclick="resetFilters()" disabled>–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
        </div>
      </div>

      <div class="row">
        <button id="btnExportDailyTxt" onclick="exportDailySummaryTxt()" disabled>–í—ã–≥—Ä—É–∑–∏—Ç—å —Å–≤–æ–¥–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (TXT –ø–æ –¥–Ω—è–º)</button>
        <button id="btnExportCouriers" class="secondary" onclick="exportCouriers()" disabled>–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–π—Ç–∏–Ω–≥–∞ –∫—É—Ä—å–µ—Ä–æ–≤ (CSV)</button>

        <span class="pill">Drilldown –∫—É—Ä—å–µ—Ä: <strong id="drillLabel">–Ω–µ—Ç</strong></span>
        <span class="pill">–ö—É—Ä—å–µ—Ä–æ–≤ –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ: <strong id="courier-count">0</strong></span>
      </div>
    </div>

    <!-- Output -->
    <div id="output" style="display:none;">
      <h2 id="stats-title">üìã –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
      <div class="grid4" id="general-stats"></div>

      <h2>üìà –ê–Ω–∞–ª–∏–∑ –∑–∞–∫–∞–∑–æ–≤ –ø–æ —á–∞—Å–∞–º</h2>
      <div class="two">
        <div class="chart-container">
          <canvas id="hourlyPeaksChart"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="latenessChart"></canvas>
        </div>
      </div>

      <h2>üìÖ –ê–Ω–∞–ª–∏–∑ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</h2>
      <div class="table-container">
        <table id="day-of-week-table"></table>
      </div>

      <h2>üßë‚Äçüöö –†–µ–π—Ç–∏–Ω–≥ –∫—É—Ä—å–µ—Ä–æ–≤</h2>
      <div class="hint" style="margin-bottom:8px">
        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–æ–∫—É –∫—É—Ä—å–µ—Ä–∞ ‚Äî –≤–∫–ª—é—á–∏—Ç—Å—è drilldown (–≤—Å–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏/–≥—Ä–∞—Ñ–∏–∫–∏ –ø–µ—Ä–µ—Å—Ç—Ä–æ—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ —ç—Ç–æ–º—É –∫—É—Ä—å–µ—Ä—É). –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫ ‚Äî –æ—Ç–∫–ª—é—á–∏—Ç.
      </div>
      <div class="table-container">
        <table id="courier-rating-table"></table>
      </div>

      <h2>‚è± –§–∞–∑—ã (—Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è)</h2>
      <div class="table-container">
        <table id="phases-table"></table>
      </div>
    </div>
  </div>

  <div id="toasts"></div>

<script>
/* =======================
   STATE
======================= */
let allData = [];
let hourlyChart = null;
let latenessChart = null;
let courierData = [];
let activeDrilldownCourier = null;

/* =======================
   UX helpers
======================= */
function toast(message, type = "info", ms = 3800){
  const wrap = document.getElementById("toasts");
  const el = document.createElement("div");
  el.className = "toast" + (type === "ok" ? " ok" : type === "err" ? " err" : "");
  el.innerHTML = `<div class="dot"></div><div>${message}</div>`;
  wrap.appendChild(el);
  setTimeout(()=>{ el.style.opacity="0"; el.style.transform="translateY(6px)"; }, ms - 350);
  setTimeout(()=>{ el.remove(); }, ms);
}
function setStatus(text){
  document.getElementById("statusText").textContent = text;
}
function setDrillLabel(){
  document.getElementById("drillLabel").textContent = activeDrilldownCourier ? activeDrilldownCourier : "–Ω–µ—Ç";
}
function setEnabled(enabled){
  document.getElementById("btnApply").disabled = !enabled;
  document.getElementById("btnResetFilters").disabled = !enabled;
  document.getElementById("btnExportDailyTxt").disabled = !enabled;
  document.getElementById("btnExportCouriers").disabled = !enabled;
  document.getElementById("btnClear").disabled = !enabled && allData.length === 0;
}

/* =======================
   Parsing helpers
======================= */
function parseDateTime(d){
  if (!d) return null;
  const s = String(d).trim();
  if (!s) return null;

  // If Excel gave us a Date object:
  if (d instanceof Date && !isNaN(d.getTime())) return d;

  // If Excel gave us a serial number (XLSX) or numeric string
  if (typeof d === "number" && isFinite(d)){
    const excelEpoch = new Date(Date.UTC(1899, 11, 30));
    const ms = Math.round(d * 86400000);
    return new Date(excelEpoch.getTime() + ms);
  }

  if (/^\d+(\.\d+)?$/.test(s)){
    const num = Number(s);
    if (isFinite(num)){
      const excelEpoch = new Date(Date.UTC(1899, 11, 30));
      const ms = Math.round(num * 86400000);
      return new Date(excelEpoch.getTime() + ms);
    }
  }

  // normalize common formats: "DD.MM.YYYY HH:MM:SS" or "DD.MM.YYYY HH:MM"
  // also accept "YYYY-MM-DD HH:MM:SS"
  const cleaned = s.replace(/\u00A0/g, " ").trim();

  // Try Date parsing directly (works for ISO mostly)
  const direct = new Date(cleaned);
  if (!isNaN(direct.getTime())) return direct;

  // Try RU format
  // Split date and time
  const parts = cleaned.split(" ");
  const datePart = parts[0];
  const timePart = parts[1] || "00:00:00";

  const dmy = datePart.split(/[.\-\/]/).map(x=>x.trim());
  if (dmy.length === 3){
    let day = Number(dmy[0]);
    let month = Number(dmy[1]);
    let year = Number(dmy[2]);

    // If first token looks like year (YYYY-MM-DD)
    if (year < 100 && dmy[0].length === 4){
      year = Number(dmy[0]);
      month = Number(dmy[1]);
      day = Number(dmy[2]);
    }

    const t = timePart.split(":").map(n=>Number(n));
    const hh = t[0] || 0, mm = t[1] || 0, ss = t[2] || 0;

    const dt = new Date(year, (month-1), day, hh, mm, ss);
    return isNaN(dt.getTime()) ? null : dt;
  }

  return null;
}

function timeDiffInMinutes(start, end){
  if (!start || !end) return null;
  return (end - start) / 60000;
}

function getAverage(arr){
  const n = arr.filter(v => v != null && isFinite(v));
  if (!n.length) return "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";
  const avg = n.reduce((a,b)=>a+b,0) / n.length;
  return String(Math.round(avg));
}

function formatYMD(dateObj){
  const y = dateObj.getFullYear();
  const m = String(dateObj.getMonth()+1).padStart(2,"0");
  const d = String(dateObj.getDate()).padStart(2,"0");
  return `${y}-${m}-${d}`;
}

/* =======================
   Upload + parse CSV/XLSX
======================= */
const fileInput = document.getElementById("file-input");
fileInput.addEventListener("change", (e)=>{
  const f = e.target.files?.[0];
  if (f) handleFileUpload(f);
});

const dropZone = document.getElementById("dropZone");
dropZone.addEventListener("dragover", (e)=>{
  e.preventDefault();
  dropZone.classList.add("dragover");
});
dropZone.addEventListener("dragleave", ()=>{
  dropZone.classList.remove("dragover");
});
dropZone.addEventListener("drop", (e)=>{
  e.preventDefault();
  dropZone.classList.remove("dragover");
  const f = e.dataTransfer.files?.[0];
  if (f) handleFileUpload(f);
});

document.getElementById("btnClear").addEventListener("click", ()=>{
  allData = [];
  courierData = [];
  activeDrilldownCourier = null;
  setDrillLabel();
  setStatus("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");
  document.getElementById("output").style.display = "none";
  fileInput.value = "";
  setEnabled(false);
  document.getElementById("courier-count").textContent = "0";
  toast("–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã", "ok");
});

function handleFileUpload(file){
  const name = file.name.toLowerCase();
  setStatus("–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶");
  setEnabled(false);

  const reader = new FileReader();
  reader.onerror = () => {
    setStatus("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞");
    toast("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª", "err");
    setEnabled(false);
  };

  reader.onload = (evt)=>{
    try{
      if (name.endsWith(".xlsx")){
        const data = new Uint8Array(evt.target.result);
        const wb = XLSX.read(data, { type:"array", cellDates:true });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, { defval:"", raw:false });
        allData = json;
      } else {
        const text = String(evt.target.result || "");
        allData = parseCSV(text);
      }

      if (!allData.length){
        setStatus("–§–∞–π–ª –ø—É—Å—Ç–æ–π / –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω");
        toast("–ù–µ –Ω–∞—à—ë–ª —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª–µ", "err");
        setEnabled(false);
        return;
      }

      setStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å—Ç—Ä–æ–∫: ${allData.length}`);
      toast(`–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: ${file.name} (—Å—Ç—Ä–æ–∫: ${allData.length})`, "ok");
      setEnabled(true);
      document.getElementById("btnClear").disabled = false;

      // Auto-run once
      runAnalysis();

    } catch (err){
      console.error(err);
      setStatus("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞");
      toast("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞. –ü—Ä–æ–≤–µ—Ä—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–ª–æ–Ω–æ–∫.", "err");
      setEnabled(false);
    }
  };

  if (name.endsWith(".xlsx")){
    reader.readAsArrayBuffer(file);
  } else {
    reader.readAsText(file, "UTF-8");
  }
}

function parseCSV(text){
  // Simple CSV parser with ; or , separator
  const lines = text.split(/\r?\n/).filter(l => l.trim().length);
  if (!lines.length) return [];

  // detect delimiter
  const headerLine = lines[0];
  const semi = (headerLine.match(/;/g)||[]).length;
  const comma = (headerLine.match(/,/g)||[]).length;
  const delim = semi >= comma ? ";" : ",";

  const headers = headerLine.split(delim).map(h=>h.trim().replace(/^"|"$/g,""));
  const out = [];

  for (let i=1;i<lines.length;i++){
    const rowLine = lines[i];
    // naive split respecting quotes
    const cells = [];
    let cur = "";
    let inQ = false;
    for (let j=0;j<rowLine.length;j++){
      const ch = rowLine[j];
      if (ch === '"'){
        inQ = !inQ;
        continue;
      }
      if (ch === delim && !inQ){
        cells.push(cur);
        cur = "";
      } else {
        cur += ch;
      }
    }
    cells.push(cur);

    const obj = {};
    headers.forEach((h, idx)=>{
      obj[h] = (cells[idx] ?? "").trim();
    });
    out.push(obj);
  }
  return out;
}

function normalizeKey(key){
  return String(key)
    .replace(/\uFEFF/g, "")
    .trim()
    .replace(/\s+/g, " ")
    .toLowerCase();
}

function getRowValue(row, normalizedRow, name){
  if (Object.prototype.hasOwnProperty.call(row, name)) return row[name];
  return normalizedRow.get(normalizeKey(name));
}

/* =======================
   Filters UI
======================= */
function toggleMode(){
  const mode = document.getElementById("mode-selector").value;
  document.getElementById("date-inputs-day").style.display = (mode === "day") ? "flex" : "none";
  document.getElementById("date-inputs-period").style.display = (mode === "period") ? "flex" : "none";
}

function resetFilters(){
  document.getElementById("mode-selector").value = "day";
  toggleMode();
  document.getElementById("date-start").value = "";
  document.getElementById("date-start-period").value = "";
  document.getElementById("date-end-period").value = "";
  document.getElementById("type-filter").value = "all";
  document.getElementById("lateness-filter").value = "all";
  activeDrilldownCourier = null;
  setDrillLabel();
  toast("–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã", "ok");
  runAnalysis();
}

/* =======================
   Core processing
======================= */
function getDateRange(){
  const mode = document.getElementById("mode-selector").value;
  if (mode === "day"){
    const v = document.getElementById("date-start").value;
    if (!v) return { start:null, end:null };
    const start = new Date(v + "T00:00:00");
    const end = new Date(v + "T23:59:59");
    return { start, end };
  } else {
    const a = document.getElementById("date-start-period").value;
    const b = document.getElementById("date-end-period").value;
    if (!a || !b) return { start:null, end:null };
    const start = new Date(a + "T00:00:00");
    const end = new Date(b + "T23:59:59");
    return { start, end };
  }
}

function preprocessAllRows(){
  // Map raw rows -> computed fields
  // Required columns (by name as in your original):
  // '–û–±–µ—â–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è', '–ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–∫–∞–∑–∞ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ', '–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ', '–ü–µ—Ä–µ–¥–∞—á–∞ –∫—É—Ä—å–µ—Ä—É', '–ü–µ—Ä–µ–¥–∞–Ω –≥–æ—Å—Ç—é', '–û–±—â–µ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞', '–§–ò–û –ö—É—Ä—å–µ—Ä–∞'
  return allData.map(row=>{
    const normalizedRow = new Map();
    Object.entries(row).forEach(([key, value])=>{
      normalizedRow.set(normalizeKey(key), value);
    });

    const promised = parseDateTime(getRowValue(row, normalizedRow, "–û–±–µ—â–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è"));
    const accepted = parseDateTime(getRowValue(row, normalizedRow, "–ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–∫–∞–∑–∞ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ"));
    const prepared = parseDateTime(getRowValue(row, normalizedRow, "–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ"));
    const handedOver = parseDateTime(getRowValue(row, normalizedRow, "–ü–µ—Ä–µ–¥–∞—á–∞ –∫—É—Ä—å–µ—Ä—É"));
    const handedToGuest = parseDateTime(getRowValue(row, normalizedRow, "–ü–µ—Ä–µ–¥–∞–Ω –≥–æ—Å—Ç—é"));
    const totalDeliveryTime = parseDateTime(getRowValue(row, normalizedRow, "–û–±—â–µ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞"));

    const courierNameRaw = (getRowValue(row, normalizedRow, "–§–ò–û –ö—É—Ä—å–µ—Ä–∞") ?? "").toString().trim();
    const isCourier = !!courierNameRaw;

    const actualCompletionTime = isCourier ? (handedToGuest || totalDeliveryTime) : prepared;
    const onTimeDiff = (promised && actualCompletionTime) ? timeDiffInMinutes(promised, actualCompletionTime) : null;
    const isLate = (onTimeDiff != null) ? (onTimeDiff > 0) : false;

    const prepTime = timeDiffInMinutes(accepted, prepared);
    const courierWaitingTime = timeDiffInMinutes(prepared, handedOver);
    const totalKitchenTime = timeDiffInMinutes(accepted, handedOver);
    const travelTime = isCourier ? timeDiffInMinutes(handedOver, actualCompletionTime) : null;

    return {
      ...row,
      promised, accepted, prepared, handedOver, handedToGuest, totalDeliveryTime,
      courierName: courierNameRaw || "–°–∞–º–æ–≤—ã–≤–æ–∑",
      isCourier,
      actualCompletionTime,
      onTimeDiff,
      isLate,
      prepTime,
      courierWaitingTime,
      totalKitchenTime,
      travelTime
    };
  }).filter(r => r.accepted); // –º–∏–Ω–∏–º–∞–ª—å–Ω–æ –∂–∏–∑–Ω–µ—Å–ø–æ—Å–æ–±–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
}

function applyAdvancedFilters(rows){
  let out = rows.slice();

  // type filter
  const typeFilter = document.getElementById("type-filter").value;
  if (typeFilter === "delivery") out = out.filter(r => r.isCourier);
  if (typeFilter === "pickup") out = out.filter(r => !r.isCourier);

  // lateness filter
  const latenessFilter = document.getElementById("lateness-filter").value;
  if (latenessFilter === "late") out = out.filter(r => r.isLate);
  if (latenessFilter === "ontime") out = out.filter(r => !r.isLate);

  // drilldown courier
  if (activeDrilldownCourier){
    out = out.filter(r => r.courierName === activeDrilldownCourier);
  }

  return out;
}

function applyDateFilter(rows, start, end){
  if (!start || !end) return rows;
  return rows.filter(r => r.accepted >= start && r.accepted <= end);
}

/* =======================
   Stats builders
======================= */
function getStats(rows){
  const total = rows.length;
  const delivery = rows.filter(r => r.isCourier).length;
  const pickup = total - delivery;
  const lateCount = rows.filter(r => r.isLate).length;
  const latePct = total ? Math.round((lateCount / total) * 100) : 0;

  const kitchen = getAverage(rows.map(r => r.totalKitchenTime));
  const travel = getAverage(rows.filter(r => r.isCourier).map(r => r.travelTime));

  return { total, delivery, pickup, latePct, kitchen, travel };
}

function getPhaseStats(rows){
  const deliveryRows = rows.filter(r => r.isCourier);
  const onTimeDeliveryPct = deliveryRows.length
    ? String(Math.round(100 - (deliveryRows.filter(r => r.isLate).length / deliveryRows.length) * 100))
    : "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";

  return {
    prepTime: getAverage(rows.map(r => r.prepTime)),
    courierWait: getAverage(rows.map(r => r.courierWaitingTime)),
    totalKitchen: getAverage(rows.map(r => r.totalKitchenTime)),
    travelTime: getAverage(deliveryRows.map(r => r.travelTime)),
    onTimeDeliveryPct
  };
}

function buildGeneralStatsUI(stats, start, end){
  const box = document.getElementById("general-stats");
  box.innerHTML = "";

  const dateLabel = (start && end)
    ? (formatYMD(start) === formatYMD(end) ? formatYMD(start) : `${formatYMD(start)} ‚Üí ${formatYMD(end)}`)
    : "–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –¥–∞—Ç—ã";

  const items = [
    { k:"–ü–µ—Ä–∏–æ–¥", v: dateLabel, s:"–ø–æ '–ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–∫–∞–∑–∞ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ'" },
    { k:"–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤", v: stats.total, s:"–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤" },
    { k:"–û–ø–æ–∑–¥–∞–ª–∏", v: stats.latePct + "%", s:"–ø–æ –ª–æ–≥–∏–∫–µ –¥–æ—Å—Ç–∞–≤–∫–∞/—Å–∞–º–æ–≤—ã–≤–æ–∑" },
    { k:"–°–±–æ—Ä–∫–∞ –∑–∞–∫–∞–∑–∞ (—Å—Ä–µ–¥–Ω–µ–µ)", v: stats.kitchen === "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" ? "‚Äî" : stats.kitchen + " –º–∏–Ω", s:"accepted ‚Üí handedOver" },
    { k:"–ü—É—Ç—å –∫—É—Ä—å–µ—Ä–∞ (—Å—Ä–µ–¥–Ω–µ–µ)", v: stats.travel === "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" ? "‚Äî" : stats.travel + " –º–∏–Ω", s:"handedOver ‚Üí delivered" },
    { k:"–î–æ—Å—Ç–∞–≤–∫–∞ / –°–∞–º–æ–≤—ã–≤–æ–∑", v: `${stats.delivery} / ${stats.pickup}`, s:"–ø–æ –Ω–∞–ª–∏—á–∏—é –§–ò–û –ö—É—Ä—å–µ—Ä–∞" },
    { k:"Drilldown –∫—É—Ä—å–µ—Ä", v: activeDrilldownCourier ? activeDrilldownCourier : "–Ω–µ—Ç", s:"–≤–ª–∏—è–µ—Ç –Ω–∞ –≤—Å–µ —Ä–∞—Å—á—ë—Ç—ã" },
    { k:"–≠–∫—Å–ø–æ—Ä—Ç TXT", v: "–ø–æ –¥–Ω—è–º", s:"–¥–∞—Ç–∞ = accepted" }
  ];

  items.forEach(it=>{
    const el = document.createElement("div");
    el.className = "stat";
    el.innerHTML = `<div class="k">${it.k}</div><div class="v">${it.v}</div><div class="s">${it.s}</div>`;
    box.appendChild(el);
  });
}

function buildPhasesTable(phase){
  const t = document.getElementById("phases-table");
  t.innerHTML = `
    <thead>
      <tr>
        <th>–§–∞–∑–∞</th>
        <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
        <th>–ö–∞–∫ —Å—á–∏—Ç–∞–µ–º</th>
      </tr>
    </thead>
    <tbody>
      <tr><td>–ì–æ—Ç–æ–≤–∫–∞ –±–ª—é–¥</td><td>${phase.prepTime} –º–∏–Ω</td><td>accepted ‚Üí prepared</td></tr>
      <tr><td>–û–∂–∏–¥–∞–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞</td><td>${phase.courierWait} –º–∏–Ω</td><td>prepared ‚Üí handedOver</td></tr>
      <tr><td>–í—Å—è —Å–±–æ—Ä–∫–∞ –∑–∞–∫–∞–∑–∞</td><td>${phase.totalKitchen} –º–∏–Ω</td><td>accepted ‚Üí handedOver</td></tr>
      <tr><td>–ü—É—Ç—å –∫—É—Ä—å–µ—Ä–∞</td><td>${phase.travelTime} –º–∏–Ω</td><td>handedOver ‚Üí delivered (—Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç–∞–≤–∫–∞)</td></tr>
      <tr><td>–°–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏</td><td>${phase.onTimeDeliveryPct}%</td><td>—Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç–∞–≤–∫–∞ (late=false)</td></tr>
    </tbody>
  `;
}

function buildDayOfWeekTable(rows){
  // group by day name
  const map = new Map();
  rows.forEach(r=>{
    const d = r.accepted;
    const day = d.toLocaleDateString("ru-RU", { weekday:"long" });
    if (!map.has(day)) map.set(day, []);
    map.get(day).push(r);
  });

  const order = ["–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫","–≤—Ç–æ—Ä–Ω–∏–∫","—Å—Ä–µ–¥–∞","—á–µ—Ç–≤–µ—Ä–≥","–ø—è—Ç–Ω–∏—Ü–∞","—Å—É–±–±–æ—Ç–∞","–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"];
  const days = Array.from(map.keys()).sort((a,b)=>order.indexOf(a)-order.indexOf(b));

  const t = document.getElementById("day-of-week-table");
  let body = "";
  days.forEach(day=>{
    const arr = map.get(day);
    const stats = getStats(arr);
    body += `
      <tr>
        <td>${day}</td>
        <td>${stats.total}</td>
        <td>${stats.latePct}%</td>
        <td>${stats.kitchen === "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" ? "‚Äî" : stats.kitchen + " –º–∏–Ω"}</td>
        <td>${stats.travel === "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" ? "‚Äî" : stats.travel + " –º–∏–Ω"}</td>
      </tr>
    `;
  });

  t.innerHTML = `
    <thead>
      <tr>
        <th>–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏</th>
        <th>–ó–∞–∫–∞–∑–æ–≤</th>
        <th>–û–ø–æ–∑–¥–∞–ª–∏</th>
        <th>–°–±–æ—Ä–∫–∞ (—Å—Ä–µ–¥–Ω–µ–µ)</th>
        <th>–ü—É—Ç—å –∫—É—Ä—å–µ—Ä–∞ (—Å—Ä–µ–¥–Ω–µ–µ)</th>
      </tr>
    </thead>
    <tbody>${body || `<tr><td colspan="5">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`}</tbody>
  `;
}

function buildCourierRating(rows){
  // build rating only for deliveries with courier name
  const deliveries = rows.filter(r => r.isCourier && r.courierName && r.courierName !== "–°–∞–º–æ–≤—ã–≤–æ–∑");
  const map = new Map();
  deliveries.forEach(r=>{
    if (!map.has(r.courierName)) map.set(r.courierName, []);
    map.get(r.courierName).push(r);
  });

  courierData = Array.from(map.entries()).map(([name, arr])=>{
    const total = arr.length;
    const latePct = total ? Math.round((arr.filter(x=>x.isLate).length/total)*100) : 0;
    const travel = getAverage(arr.map(x=>x.travelTime));
    const kitchen = getAverage(arr.map(x=>x.totalKitchenTime));
    return { name, total, latePct, travel, kitchen };
  }).sort((a,b)=> (a.latePct - b.latePct) || (b.total - a.total));

  document.getElementById("courier-count").textContent = String(courierData.length);

  const t = document.getElementById("courier-rating-table");
  let body = "";
  courierData.forEach((c, idx)=>{
    const isActive = activeDrilldownCourier === c.name;
    body += `
      <tr data-courier="${encodeURIComponent(c.name)}" style="cursor:pointer; ${isActive ? "background:#eff6ff" : ""}">
        <td>${idx+1}</td>
        <td><b>${c.name}</b>${isActive ? ` <span class="pill" style="margin-left:8px">drilldown</span>` : ""}</td>
        <td>${c.total}</td>
        <td>${c.latePct}%</td>
        <td>${c.kitchen === "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" ? "‚Äî" : c.kitchen + " –º–∏–Ω"}</td>
        <td>${c.travel === "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" ? "‚Äî" : c.travel + " –º–∏–Ω"}</td>
      </tr>
    `;
  });

  t.innerHTML = `
    <thead>
      <tr>
        <th>#</th>
        <th>–ö—É—Ä—å–µ—Ä</th>
        <th>–î–æ—Å—Ç–∞–≤–æ–∫</th>
        <th>–û–ø–æ–∑–¥–∞–ª–∏</th>
        <th>–°–±–æ—Ä–∫–∞ (—Å—Ä.)</th>
        <th>–ü—É—Ç—å (—Å—Ä.)</th>
      </tr>
    </thead>
    <tbody>
      ${body || `<tr><td colspan="6">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`}
    </tbody>
  `;

  // Row click drilldown
  t.querySelectorAll("tbody tr[data-courier]").forEach(tr=>{
    tr.addEventListener("click", ()=>{
      const name = decodeURIComponent(tr.getAttribute("data-courier"));
      if (activeDrilldownCourier === name){
        activeDrilldownCourier = null;
        toast("Drilldown –æ—Ç–∫–ª—é—á—ë–Ω", "ok");
      } else {
        activeDrilldownCourier = name;
        toast(`Drilldown: ${name}`, "ok");
      }
      setDrillLabel();
      runAnalysis();
    });
  });
}

/* =======================
   Charts
======================= */
function buildHourlyChart(rows){
  // group by hour from accepted
  const hours = Array.from({length:24}, (_,i)=>i);
  const counts = new Array(24).fill(0);
  const lateCounts = new Array(24).fill(0);

  rows.forEach(r=>{
    const h = r.accepted.getHours();
    counts[h] += 1;
    if (r.isLate) lateCounts[h] += 1;
  });

  const latePct = counts.map((c,i)=> c ? Math.round((lateCounts[i]/c)*100) : 0);

  const ctx = document.getElementById("hourlyPeaksChart").getContext("2d");
  if (hourlyChart) hourlyChart.destroy();

  hourlyChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: hours.map(h=>String(h).padStart(2,"0")+":00"),
      datasets: [
        { label:"–ó–∞–∫–∞–∑—ã", data: counts },
        { label:"–û–ø–æ–∑–¥–∞–ª–∏ (%)", data: latePct, type:"line", yAxisID:"y2" }
      ]
    },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      scales: {
        y: { beginAtZero:true, title:{display:true, text:"–ö–æ–ª-–≤–æ"} },
        y2: { beginAtZero:true, position:"right", min:0, max:100, grid:{drawOnChartArea:false}, title:{display:true, text:"%"} }
      }
    }
  });
}

function buildLatenessChart(rows){
  // distribution of onTimeDiff (minutes) for late only
  const bins = [
    { name:"0‚Äì5", min:0, max:5 },
    { name:"6‚Äì10", min:6, max:10 },
    { name:"11‚Äì15", min:11, max:15 },
    { name:"16‚Äì30", min:16, max:30 },
    { name:"31‚Äì60", min:31, max:60 },
    { name:"60+", min:61, max:1e9 }
  ];
  const counts = bins.map(()=>0);

  rows.forEach(r=>{
    if (r.onTimeDiff == null) return;
    if (r.onTimeDiff <= 0) return;
    const m = Math.round(r.onTimeDiff);
    const idx = bins.findIndex(b => m >= b.min && m <= b.max);
    if (idx >= 0) counts[idx] += 1;
  });

  const ctx = document.getElementById("latenessChart").getContext("2d");
  if (latenessChart) latenessChart.destroy();

  latenessChart = new Chart(ctx, {
    type:"bar",
    data:{
      labels: bins.map(b=>b.name),
      datasets:[
        { label:"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–æ–∑–¥–∞–Ω–∏–π", data: counts }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{ y:{ beginAtZero:true } }
    }
  });
}

/* =======================
   Main run
======================= */
function runAnalysis(){
  if (!allData || !allData.length){
    toast("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª", "err");
    return;
  }

  const { start, end } = getDateRange();

  // If user didn't set date filters, we still allow analysis on all data
  const base = preprocessAllRows();
  let rows = base;

  // date filter if provided
  if (start && end){
    rows = applyDateFilter(rows, start, end);
  }

  // advanced filters + drilldown
  rows = applyAdvancedFilters(rows);

  // render
  document.getElementById("output").style.display = "block";
  setDrillLabel();

  const stats = getStats(rows);
  buildGeneralStatsUI(stats, start, end);

  buildHourlyChart(rows);
  buildLatenessChart(rows);
  buildDayOfWeekTable(rows);
  buildCourierRating(rows);
  buildPhasesTable(getPhaseStats(rows));

  // title
  const title = document.getElementById("stats-title");
  title.textContent = "üìã –°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" + (activeDrilldownCourier ? ` ‚Äî ${activeDrilldownCourier}` : "");

  // If nothing
  if (!rows.length){
    toast("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º", "err");
  }
}

/* =======================
   Export couriers CSV
======================= */
function exportCouriers(){
  if (!courierData || !courierData.length){
    toast("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ä–µ–π—Ç–∏–Ω–≥–∞ –∫—É—Ä—å–µ—Ä–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞", "err");
    return;
  }
  const headers = ["–ö—É—Ä—å–µ—Ä","–î–æ—Å—Ç–∞–≤–æ–∫","–û–ø–æ–∑–¥–∞–ª–∏ %","–°–±–æ—Ä–∫–∞ (—Å—Ä, –º–∏–Ω)","–ü—É—Ç—å (—Å—Ä, –º–∏–Ω)"];
  const lines = [headers.join(";")];

  courierData.forEach(c=>{
    lines.push([
      c.name,
      c.total,
      c.latePct,
      c.kitchen === "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" ? "" : c.kitchen,
      c.travel === "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" ? "" : c.travel
    ].join(";"));
  });

  downloadTextFile(`courier_rating_${new Date().toISOString().slice(0,10)}.csv`, lines.join("\n"));
  toast("CSV —Ä–µ–π—Ç–∏–Ω–≥–∞ –∫—É—Ä—å–µ—Ä–æ–≤ —Å–∫–∞—á–∞–Ω", "ok");
}

/* =======================
   Export daily TXT summaries
======================= */
function buildDailyTxtReport(dateKey, dayRows){
  const stats = getStats(dayRows);
  const phase = getPhaseStats(dayRows);

  const typeFilter = document.getElementById("type-filter").value;
  const latenessFilter = document.getElementById("lateness-filter").value;
  const drill = activeDrilldownCourier ? activeDrilldownCourier : "–Ω–µ—Ç";

  const lines = [];
  lines.push(`–°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å: ${dateKey}`);
  lines.push(`–§–∏–ª—å—Ç—Ä—ã: —Ç–∏–ø=${typeFilter}, –æ–ø–æ–∑–¥–∞–Ω–∏–µ=${latenessFilter}, drilldown(–∫—É—Ä—å–µ—Ä)=${drill}`);
  lines.push(`==================================================`);
  lines.push(`–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: ${stats.total}`);
  lines.push(`–î–æ—Å—Ç–∞–≤–∫–∞: ${stats.delivery}`);
  lines.push(`–°–∞–º–æ–≤—ã–≤–æ–∑: ${stats.pickup}`);
  lines.push(`–û–ø–æ–∑–¥–∞–ª–∏: ${stats.latePct}%`);
  lines.push(`–°–±–æ—Ä–∫–∞ –∑–∞–∫–∞–∑–∞ (—Å—Ä–µ–¥–Ω–µ–µ): ${stats.kitchen} –º–∏–Ω`);
  lines.push(`–ü—É—Ç—å –∫—É—Ä—å–µ—Ä–∞ (—Å—Ä–µ–¥–Ω–µ–µ): ${stats.travel} –º–∏–Ω`);
  lines.push(`--------------------------------------------------`);
  lines.push(`–§–∞–∑—ã (—Å—Ä–µ–¥–Ω–µ–µ):`);
  lines.push(`–ì–æ—Ç–æ–≤–∫–∞ –±–ª—é–¥: ${phase.prepTime} –º–∏–Ω`);
  lines.push(`–û–∂–∏–¥–∞–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞: ${phase.courierWait} –º–∏–Ω`);
  lines.push(`–í—Å—è —Å–±–æ—Ä–∫–∞ –∑–∞–∫–∞–∑–∞: ${phase.totalKitchen} –º–∏–Ω`);
  lines.push(`–ü—É—Ç—å –∫—É—Ä—å–µ—Ä–∞: ${phase.travelTime} –º–∏–Ω`);
  lines.push(`–°–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç–∞–≤–∫–∞): ${phase.onTimeDeliveryPct}% –≤–æ–≤—Ä–µ–º—è`);
  lines.push(`==================================================`);
  lines.push(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleString("ru-RU")}`);

  return lines.join("\n");
}

function downloadTextFile(filename, content){
  const blob = new Blob([content], { type:"text/plain;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

function getDailyStats(dayRows){
  const total = dayRows.length;

  const deliveryRows = dayRows.filter(r => r.isCourier);
  const pickupRows = dayRows.filter(r => !r.isCourier);

  const delivery = deliveryRows.length;
  const pickup = pickupRows.length;

  const lateDelivery = deliveryRows.filter(r => r.isLate).length;
  const latePickup = pickupRows.filter(r => r.isLate).length;

  const avgKitchen = getAverage(dayRows.map(r => r.totalKitchenTime)); // accepted ‚Üí handedOver
  const avgTravel = getAverage(deliveryRows.map(r => r.travelTime));   // handedOver ‚Üí delivered (—Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç–∞–≤–∫–∞)

  return { total, delivery, pickup, lateDelivery, latePickup, avgKitchen, avgTravel };
}

function buildSingleTxtReportByDays(daysSorted, mapByDay){
  const typeFilter = document.getElementById("type-filter")?.value || "all";
  const latenessFilter = document.getElementById("lateness-filter")?.value || "all";
  const drill = activeDrilldownCourier ? activeDrilldownCourier : "–Ω–µ—Ç";

  const lines = [];
  lines.push(`–°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º`);
  lines.push(`–§–∏–ª—å—Ç—Ä—ã: —Ç–∏–ø=${typeFilter}, –æ–ø–æ–∑–¥–∞–Ω–∏–µ=${latenessFilter}, drilldown(–∫—É—Ä—å–µ—Ä)=${drill}`);
  lines.push(`–î–∞—Ç–∞ –æ—Ç—á—ë—Ç–∞: ${new Date().toLocaleString("ru-RU")}`);
  lines.push(`============================================================`);
  lines.push(``);

  daysSorted.forEach((dayKey) => {
    const dayRows = mapByDay.get(dayKey) || [];
    const s = getDailyStats(dayRows);

    // –ü—Ä–æ—Ü–µ–Ω—Ç—ã –ø–æ –æ–ø–æ–∑–¥–∞–Ω–∏—è–º (–ø—Ä–∏—è—Ç–Ω–æ –¥–ª—è —á—Ç–µ–Ω–∏—è, –Ω–æ ‚Äú—è–¥—Ä–æ‚Äù ‚Äî —ç—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞)
    const lateDeliveryPct = s.delivery ? Math.round((s.lateDelivery / s.delivery) * 100) : 0;
    const latePickupPct = s.pickup ? Math.round((s.latePickup / s.pickup) * 100) : 0;

    lines.push(`üìÖ ${dayKey}`);
    lines.push(`  –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: ${s.total}`);
    lines.push(`  –î–æ—Å—Ç–∞–≤–∫–∞: ${s.delivery}`);
    lines.push(`  –°–∞–º–æ–≤—ã–≤–æ–∑: ${s.pickup}`);
    lines.push(`  –û–ø–æ–∑–¥–∞–ª–∏ (–¥–æ—Å—Ç–∞–≤–∫–∞): ${s.lateDelivery} (${lateDeliveryPct}%)`);
    lines.push(`  –û–ø–æ–∑–¥–∞–ª–∏ (—Å–∞–º–æ–≤—ã–≤–æ–∑): ${s.latePickup} (${latePickupPct}%)`);
    lines.push(`  –°–±–æ—Ä–∫–∞ –∑–∞–∫–∞–∑–æ–≤ (—Å—Ä–µ–¥–Ω–µ–µ): ${s.avgKitchen} –º–∏–Ω`);
    lines.push(`  –ü—É—Ç—å –∫—É—Ä—å–µ—Ä–∞ (—Å—Ä–µ–¥–Ω–µ–µ): ${s.avgTravel} –º–∏–Ω`);
    lines.push(`------------------------------------------------------------`);
  });

  return lines.join("\n");
}

// –ï—Å–ª–∏ —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å downloadTextFile() ‚Äî –Ω–µ –¥—É–±–ª–∏—Ä—É–π, –æ—Å—Ç–∞–≤—å –æ–¥–Ω—É –≤–µ—Ä—Å–∏—é
function downloadTextFile(filename, content){
  const blob = new Blob([content], { type:"text/plain;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

function exportDailySummaryTxt(){
  if (!allData || !allData.length){
    toast("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª", "err");
    return;
  }

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Å–µ–º –¥–Ω—è–º, –ø–æ—ç—Ç–æ–º—É –ù–ï –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä day/period,
  // –Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ–º advanced-—Ñ–∏–ª—å—Ç—Ä—ã –∏ drilldown (–µ—Å–ª–∏ –µ—Å—Ç—å).
  const base = preprocessAllRows();
  const filtered = applyAdvancedFilters(base);

  if (!filtered.length){
    toast("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ —Å —É—á–µ—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤", "err");
    return;
  }

  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ accepted (–ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–∫–∞–∑–∞ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ)
  const mapByDay = new Map();
  filtered.forEach(r=>{
    const dayKey = formatYMD(r.accepted);
    if (!mapByDay.has(dayKey)) mapByDay.set(dayKey, []);
    mapByDay.get(dayKey).push(r);
  });

  const daysSorted = Array.from(mapByDay.keys()).sort();
  if (!daysSorted.length){
    toast("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –¥–Ω—è –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏", "err");
    return;
  }

  const txt = buildSingleTxtReportByDays(daysSorted, mapByDay);

  const today = new Date().toISOString().slice(0,10);
  const filename = `summary_by_days_${today}.txt`;
  downloadTextFile(filename, txt);

  toast("–ï–¥–∏–Ω—ã–π TXT –æ—Ç—á—ë—Ç –ø–æ –¥–Ω—è–º —Å–∫–∞—á–∞–Ω", "ok");
}
  
function exportDailySummaryTxt(){
  if (!allData || !allData.length){
    toast("–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª", "err");
    return;
  }

  // –í–ê–ñ–ù–û: —ç–∫—Å–ø–æ—Ä—Ç –ø–æ –¥–Ω—è–º –Ω–µ –¥–æ–ª–∂–µ–Ω –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ –¥–∞—Ç—ã (–¥–µ–Ω—å/–ø–µ—Ä–∏–æ–¥),
  // –∏–Ω–∞—á–µ —Ç—ã –Ω–µ –ø–æ–ª—É—á–∏—à—å "–≤—Å–µ –¥–Ω–∏". –ó–∞—Ç–æ —É—á–∏—Ç—ã–≤–∞–µ–º advanced-—Ñ–∏–ª—å—Ç—Ä—ã –∏ drilldown.
  const base = preprocessAllRows();
  const filtered = applyAdvancedFilters(base);

  if (!filtered.length){
    toast("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏ —Å —É—á–µ—Ç–æ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤", "err");
    return;
  }

  // group by accepted date (day)
  const byDay = new Map();
  filtered.forEach(r=>{
    const key = formatYMD(r.accepted);
    if (!byDay.has(key)) byDay.set(key, []);
    byDay.get(key).push(r);
  });

  const days = Array.from(byDay.keys()).sort();
  if (!days.length){
    toast("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –¥–Ω—è –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏", "err");
    return;
  }

  toast(`–ù–∞—á–∏–Ω–∞—é –≤—ã–≥—Ä—É–∑–∫—É: —Ñ–∞–π–ª–æ–≤ ${days.length}`, "ok", 2500);

  // small delay between downloads so browser doesn't block
  days.forEach((dayKey, idx)=>{
    const dayRows = byDay.get(dayKey);
    const txt = buildDailyTxtReport(dayKey, dayRows);
    const filename = `summary_${dayKey}.txt`;
    setTimeout(()=>downloadTextFile(filename, txt), idx * 250);
  });
}

/* =======================
   Init defaults (UX)
======================= */
toggleMode();
setDrillLabel();
setEnabled(false);
setStatus("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");
</script>

</body>
</html>
